{% assign navPages = collections.all | eleventyNavigation %}
{% assign currentUrl = page.url %}
{% assign currentSection = false %}

{%- for entry in navPages[0].children -%}
  {%- if entry.url and currentUrl contains entry.url -%}
    {%- assign currentSection = entry -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

<aside
  id="section-nav"
  class="usa-layout-docs-sidenav desktop:grid-col-3 padding-y-4"
>
  <nav>
    <div class="text-uppercase text-bold margin-left-2 margin-y-2 text-ls-2">In this section:</div>
    {%- if currentSection -%}
      <ul class="usa-sidenav">
        {%- for child in currentSection.children -%}
          {%- assign isCurrentChild = false -%}
          {%- if child.url and currentUrl contains child.url -%}
            {%- assign isCurrentChild = true -%}
          {%- endif -%}
          <li class="usa-sidenav__item">
            <a
              href="{{ child.url }}"
              {%- if child.url == currentUrl -%}
                class="usa-current"
              {%- endif -%}
            >
              {{ child.title }}
            </a>
            {%- if isCurrentChild and child.children.size > 0 -%}
              <ul class="usa-sidenav__sublist">
                {%- for grandchild in child.children -%}
                  {%- unless grandchild.hideInSideNav -%}
                    <li class="usa-sidenav__item font-sans-2xs">
                      <a
                        href="{{ grandchild.url }}"
                        {%- if grandchild.url == currentUrl -%}
                          class="usa-current"
                        {%- endif -%}
                      >
                        {{ grandchild.title }}
                      </a>
                    </li>
                  {%- endunless -%}
                {%- endfor -%}
              </ul>
            {%- endif -%}
          </li>
        {%- endfor -%}
      </ul>
    {%- else -%}
      <p>No navigation found for this section.</p>
    {%- endif -%}
  </nav>

  {% if page.url contains '/resources/cases/' %}
    <section id="case-search" class="margin-top-4">
      <form id="case-search-form" class="usa-form maxw-none" role="search">
        <label class="usa-label margin-top-0" for="case-search-query">Search public files</label>
        <input
          class="usa-input"
          id="case-search-query"
          name="query"
          type="search"
          placeholder="Case number, agency, location, result..."
          autocomplete="off"
        >

        <label class="usa-label" for="case-filter-agency">Agency</label>
        <select class="usa-select" id="case-filter-agency" name="agency">
          <option value="">All agencies</option>
        </select>

        <label class="usa-label" for="case-filter-year">Year</label>
        <select class="usa-select" id="case-filter-year" name="year">
          <option value="">All years</option>
        </select>

        <button type="button" class="usa-button usa-button--outline margin-top-2 width-full" id="case-search-clear">
          Clear
        </button>
      </form>

    </section>
  {% endif %}
</aside>
